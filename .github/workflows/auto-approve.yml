name: Auto Approve PR

on:
  workflow_run:
    workflows: ["Java CI with Maven"]
    types:
      - completed

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      pull-requests: write
    
    steps:
      - name: Auto Approve PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const workflowRun = context.payload.workflow_run;
            
            // Get the PR associated with this workflow run
            const allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: workflowRun.id,
            });
            
            // Find the PR number from the workflow run
            const prRuns = await github.rest.actions.listWorkflowRunsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event: 'pull_request',
              branch: workflowRun.head_branch
            });
            
            if (prRuns.data.workflow_runs.length === 0) {
              console.log('No PR found for this workflow run');
              return;
            }
            
            // Get the PR number
            const prRunId = prRuns.data.workflow_runs[0].id;
            const prInfo = await github.rest.actions.getWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: prRunId
            });
            
            const prNumber = prInfo.data.pull_requests[0]?.number;
            if (!prNumber) {
              console.log('Could not determine PR number');
              return;
            }
            
            console.log(`Auto-approving PR #${prNumber}`);
            
            // Approve the PR
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              event: 'APPROVE',
              body: 'âœ… Automatically approved because all checks passed!'
            });
            
            console.log(`PR #${prNumber} has been automatically approved`);
